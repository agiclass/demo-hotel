**客服对话系统设计指导**

1\. **前言**

该系统设计文档意在让学员通过实际开发一个垂直领域对话系统的原型，从而更好掌握并融会贯通AGI课堂所学的知识。这里有必要强调，课上所讲的知识点，是实际生产中应用大模型技术时会涉及到的重点，但并不能覆盖自然语言处理（Natural Language Processing, NLP）及人工智能（Artificial Intelligence, AI）技术在实际生产中的全部知识。

因此，在设计该作业项目时，面向学员对技术与业务体系不同程度的学习需求，我们设计了三种不同程度设计指导，分别以不同符号标识。详细如下：

○ - 以该符号标识的内容，只需有编程基础并掌握课上所讲知识，即可以实现；

△ - 以该符号标识的内容，会涉及到课上未覆盖，但做NLP相关系统会经常用到的算法或技巧，可以认为是课上内容的一个补充。建议有意于从事NLP相关领域开发工作的同学尝试实践；

☆ -以该符号标识的内容，除了模型与算法外，会从产品和工程角度考虑一个模块的设计，因此会涉及更多的开发工作。建议实际工作中已在开发有类似产品的同学，可以通过这部分设计更好的体会产品-技术间的关联与权衡。

2\. **任务场景与数据集**

**任务**: 给定一个包含北京酒店信息的数据库，构建一个可以帮助用户选择酒店的智能客服机器人。

本项目数据集源自<https://github.com/thu-coai/CrossWOZ/tree/master>的订酒店场景。在原有数据基础上，做了裁剪和修改。具体如下。

酒店数据库中包含1132条酒店的信息，包括：

- 名称：酒店的全名
- 类型：经济型、舒适型、高档型、豪华型，四个值之一
- 地址：酒店详细地址
- 地铁：酒店最近的地铁站
- 电话：酒店联系电话
- 价格：参考价，一个数值
- 评分：0-5之间的浮点数
- 酒店设施：酒店的设施描述，每项一句，如：\"酒店各处提供wifi\"、\"24小时热水\"等

数据样例：

<img src=media/image1.png width=350/>

3\. **系统设计**

一个经典的对话系统框图如下：

<img src=media/image2.png width=500/>

**语义理解（Natural Language Understanding,
NLU）**：作用是将用户的自然语言查询（query），解析成结构化语义表示。常用的语义表示有多种形式，我们在**第4节**详细讨论。

**对话状态跟踪（Dialogue State Tracking,
DST）**：作用是根据多轮对话，维护用户的完整意图。NLU与DST的区别在于，前者重在解析当前轮输入的语义，而后者关心的是整个对话过程中用户完整意图的变化。举一个简单的例子，用户第一轮说"评分高的酒店"，这时已知的意图只有"评分=高"，而当第二轮用户补充说"豪华型的"，用户的完整意图就成了"评分=高
AND
类型=豪华型"。注意，用户意图在对话过程中不一定只是按增量补充的方式变化的，用户也能修改或重置之前的查询条件，所以当某一项意图变化时会连带其它项跟随变化，这个问题我们在**第5节**中详细讨论。

**检索与排序**：当我们有了用户完整意图后，就可以根据此意图查询数据源（数据库或三方数据查询接口）来获得满足用户需求的实体列表（在本项目中就是酒店列表）。这个检索过程根据待检索的字段的性质，可以拆解为值匹配检索、关键字检索和向量检索。必要时，对检索后的结果可以根据领域或业务know-how重新排序，以使其更符合用户预期或使用习惯。这部分内容我们将在**第6节**详细讨论。

**对话策略（Policy）**与**自然语言生成（Natural Language Generation,
NLG）**：人的对话是有策略的。当被问到一个问题时，我该回答哪些内容，用什么口径回答，是直接回答还是先通过询问、反问或澄清确认等方式收集更多信息？这就是对话策略。在传统对话系统中，Policy与NLG是分离的，Policy决策出一个抽象的语义表示，再由NLG实现成自然语言文本。（这样做的原因是当时NLG能力有限，只能拆解语义表示中的独立部分，再用模板拼接。）在大模型时代，随着NLG能力激增，Policy和NLG可以合并在一个模块中，即可以把Policy以Prompt形式来描述，直接从大模型得到NLG结果。这个过程我们在**第7节**详解。

4\. **NLU模块设计**

**4.1、语义表示**

NLU的目的是把自然语言解析成结构化语义。结构化语义有多种表示方式，常用的表示方式为Dialogue
Act和槽-值对儿的形式。Dialogue Act表示句子的意图，如：

inform：表示用户在陈述/提供信息（其中的信息就是槽-值的集合，下文详述），例如"我要便宜的酒店"；

request：表示用户在询问信息，比如"这个酒店评分多少"；

confirm：表示用户在确认某项信息，比如"这是豪华型的吧"；

这里只介绍几个常用的Dialogue
Act的例子。在大模型时代，类似request或confirm这类行为，可以交个大模型自主去回答，所以不需要专门解析这类语义了。所以我们只需要关注inform中的槽-值信息。因此，我们可以省略Dialogue
Act字段，直接解析槽-值即可。

在本项目中，用户可以直接表达的槽有5个，即名称（name）、类型（type）、评分（rating）、价格（price）和设施（facilities）。根据其值的类型和对应的数据检索方式，建议的语义表示定义如下：

<img src=media/image3.png width=550 />

以上字段，当用户未提及时都可以是null（或不出现在语义结构中）。

**4.2、模块设计**

<img src=media/image4.png width=400 />

NLU模型核心是维护一个Prompt模板，通过调用大模型，将用户query转换为上述结构化表示。

**每个槽一个模板**☆：从优化与维护的角度，可以考虑每个槽的解析单独维护一个Prompt模板。这样可以保证未来优化一个槽时，不会影响其它槽当前的解析效果。多个槽并行调用大模型来减少延时。缺点是token费用增加。

5\. **DST算法设计**

为了更好的理解DST的工作原理，我们先给出一个对话过程对应用户意图变化的例子：

<img src=media/image5.png width=450 />

在这个场景中，我们可以假设DST更新时每轮是增量补充检索条件或覆盖原有检索条件。根据这个思路，我们设计一个最简单的DST：

func stateUpdate(state, nlu_semantics):

#更新当前槽

for slot in nlu_semantics:

state\[slot\] = nlu_semantics\[slot\]

**检索后再更新**△：仔细推想不难发现，当检索条件堆叠后，会有搜不到满足条件的酒店的情况（比如"type=豪华型，price.range.upper=300"）。此时，我们就需要根据检索结果对状态做二次更新，将最优的检索结果中也不能满足的槽清空。如果排序结果，我们在第6节讨论。

6\. **检索与排序算法**

**6.1、检索**

对上述字段的检索，涉及到三种检索方式。

匹配检索：对价格、评分和类型字段，是严格的条件匹配，匹配的结果只有满足和不满足两种；

关键字检索：对名称字段，通常用户的描述与系统中的值不是严格匹配，例如用户会说"如家燕莎店"，而系统中存储的是"如家快捷酒店(北京燕莎新源里店)"，因此我们需要通过关键字检索找到最接近的实体

向量检索：对于设施字段，关键字检索有时不能准确找到匹配，例如用户说"能打麻将的"而系统中的描述是"棋牌室"。对此类情况，向量检索更优。

因为用户意图可能同时包含上述三类字段，因此我们需要做hybrid
search来满足这样检索。现在的向量数据库大多支持此类检索，例如：

<https://weaviate.io/developers/weaviate/search/hybrid>

**6.1.1、向量检索进阶☆**

在对设施做向量检索时我们面临一个问题：把全部设施作为一个向量还是每个设施一个向量？前者的弊端是不相关的设施会"稀释"检索的相关性；而后者的问题是没法表示用户要求多个设施的情况。其实这种情况最好的做法是"全部"和"局部"分别做向量表示，然后一起检索，取最终相似度最高的。支持这种检索pipeline的开源框架可以参考：<https://github.com/jina-ai/jina>

**6.2、排序**

检索引擎自带排序逻辑，在简单的场景下我们可以直接使用检索引擎的排序结果。

**6.2.1、带有业务逻辑的排序△**

检索引擎的排序完全是基于匹配度的，而我们的应用场景会带有业务的know-how。因此，更好的排序逻辑应该考虑到这些业务因素。例如，在计算酒店名称的匹配度时，"如家快捷酒店(北京燕莎新源里店)"与"汉庭新源里店"的表面匹配度（匹配4个字符）会高于与"如家"的表面匹配度（匹配2个字符），但是显然从业务视角后者更为契合。因此，此处我们应该自己设计匹配逻辑，对括号里和括号外匹配的字符给予不同的权重。

此外，当没有结果能全部满足检索条件时，我们还应该考虑，当前轮新增的条件（NLU的结果）最为重要，应为必须满足。历史轮的条件为可选项。以此排序才能让用户感知到自己的查询被正确响应了。

7\. **对话策略与NLG模块设计**

在本场景中，我们考虑三大类对话策略：

信息回复型：

找到满足条件的酒店，向用户介绍信息

找不到完全满足条件的酒店，向用户推荐部分满足的酒店

话术回复型：回答场景内非酒店相关问题

不同策略对应不同Prompt模板，我们可以将其拼装成一整个Prompt并调用大模型进行回复。

<img src=media/image6.png width=600 />

**7.1、信息回复**

在信息回复的Prompt模板中，我们可以通过Prompt指定大模型详细介绍哪些信息，或者是否比较多条结果的优劣等等，从而形成不同的回复策略。

**7.2、话术回复**

在真实业务场景中，我们会遇到与业务相关但不是信息查询类的问题。例如，用户问"你是机器人吗"、"你好笨"、"你是不是只给我推荐你们有返点的"等等。对于这类特定的问题，我们通常希望有专门的回复口径。我们可以通过在Prompt加例子的原理实现这个功能。具体说，我们在一个向量数据库中维护一批此类问题的向量和我们希望的回复口径的例子（即以问答对儿形式存储）。每次用户输入我们都检索这个向量数据库，判断是否命中库中问题，如果命中，则在Prompt中加入命中的问答对儿（可以是多个）作为例子，让大模型参考例子回答。**此处，为了对用户各种说法有更好的覆盖，可以在向量数据中存储每个问题的多种扩展问法**△。

8\. **防止Prompt注入**

参考课上所讲例子，设计Prompt注入分类器，方式Prompt注入。另外，还可以设计类似分类器**分类当前问题是否与业务场景相关**☆。如果不相关，可以限制客服机器人不要回复。（订酒店的客服机器人不应该回复诸如"美国总统是谁"这样的问题。）

9\. **集成地图API☆**

集成地图API（例如高德地图）实现"XXX附近的酒店"的查询功能。
